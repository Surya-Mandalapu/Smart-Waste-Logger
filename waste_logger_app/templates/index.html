<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Smart Waste Logger</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Recent Uploads hover effect */
    .list-group-item {
      user-select: none;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }

    .list-group-item:hover {
      background-color: #f1f9f1;
    }

    /* Scrollbar styling */
    .recent-uploads-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .recent-uploads-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(0, 128, 0, 0.3);
      border-radius: 3px;
    }

    /* For Firefox */
    .recent-uploads-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 128, 0, 0.3) transparent;
    }
  </style>
</head>

<body class="bg-light p-5">
  <div class="container">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="text-center mb-4 text-success" style="font-weight:700; letter-spacing:1px;">Smart Waste Logger</h1>
      <div>
        {% if username %}
        <span class="me-3">Welcome, <strong>{{ username }}</strong></span>
        <a href="/log" class="btn btn-outline-primary btn-sm me-2">My Full Log</a>
        <a href="/public" class="btn btn-outline-success btn-sm me-2">üåç Public Dashboard</a>
        <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
        {% else %}
        <a href="/public" class="btn btn-outline-success btn-sm me-2">üåç Public Dashboard</a>
        <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
        {% endif %}
      </div>
    </div>

    <!-- Flash Messages -->
    {% if message %}
    <div class="alert alert-success">{{ message }}</div>
    {% endif %}
    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Upload Form -->
    <form action="/classify" method="post" enctype="multipart/form-data" class="card p-4 shadow-sm mx-auto mb-5"
      style="max-width: 500px;">
      <div class="mb-3">
        <input class="form-control" type="file" name="file" accept="image/*" required
          onchange="previewImage(event); toggleSubmitButton(event)" />
      </div>

      <div class="mb-3">
        <img id="preview" src="#" alt="Image preview" class="img-fluid rounded d-none" />
      </div>

      <button type="submit" id="submitBtn" class="btn btn-success w-100" disabled>
        Check Recyclability
      </button>
    </form>

    <!-- Dashboard Section -->
    <div class="mt-5">
      <h3 class="text-center mb-4">Dashboard Overview</h3>

      <!-- Top row: Pie chart + Total CO2 + Recyclability Rate -->
      <div class="row text-center mb-4 gy-4">
        <div class="col-md-4">
          <div class="card p-4 shadow-sm">
            <h5>Recyclable vs Non-Recyclable</h5>
            <canvas id="recycleChart" aria-label="Recyclable vs Non-Recyclable doughnut chart" role="img"></canvas>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm p-3 h-100 d-flex flex-column justify-content-center">
            <h5>Total CO‚ÇÇ Emitted</h5>
            <p class="display-6 text-success mb-0">{{ total_co2 }} kg</p>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm p-3 h-100 d-flex flex-column justify-content-center">
            <h5>Recyclability Rate</h5>
            <p class="display-6 text-primary mb-0">{{ percent_recyclable }}%</p>
          </div>
        </div>
      </div>

      <!-- Bottom row: CO2 Emissions Over Time + Recent Uploads -->
      <div class="row mb-5 gy-4">
        <div class="col-md-8">
          <div class="card p-4 shadow-sm h-100">
            <h5>CO‚ÇÇ Emissions Over Time</h5>
            <canvas id="co2Chart" height="150" aria-label="Line chart of CO2 emissions over time" role="img"></canvas>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm p-3 recent-uploads-scrollbar" style="max-height: 320px; overflow-y: auto;">
            <h5 class="mb-3">Recent Uploads</h5>
            <ul class="list-group list-group-flush">
              {% for log in recent_logs[-3:] | reverse %}
              <li class="list-group-item d-flex flex-column gap-1">
                <strong class="text-success">{{ log.label | capitalize }}</strong>
                <small class="text-muted">{{ log.timestamp.strftime("%Y-%m-%d %H:%M") }}</small>
                <small>
                  CO‚ÇÇ: <span class="fw-semibold">{{ log.co2_estimate }}</span> kg &nbsp;|&nbsp;
                  {% if log.recyclable %}
                  <span class="text-success">‚ôªÔ∏è Recyclable</span>
                  {% else %}
                  <span class="text-danger">‚ùå Not Recyclable</span>
                  {% endif %}
                </small>
              </li>
              {% else %}
              <li class="list-group-item text-muted">No recent uploads</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inject co2_trend data as JSON -->
  <script id="co2-data" type="application/json">
    {{ co2_trend | tojson | safe }}
  </script>

  <!-- JS: Preview + Submit Button + Charts -->
  <script>
    function previewImage(event) {
      const [file] = event.target.files;
      const preview = document.getElementById('preview');
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.classList.remove('d-none');
      } else {
        preview.src = '#';
        preview.classList.add('d-none');
      }
    }

    function toggleSubmitButton(event) {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = !event.target.files.length;
    }

    // Parse CO‚ÇÇ trend data
    const co2Trend = JSON.parse(document.getElementById('co2-data').textContent || '{}');
    const labels = Object.keys(co2Trend);
    const data = Object.values(co2Trend);

    // Line Chart: CO‚ÇÇ Over Time
    new Chart(document.getElementById("co2Chart"), {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "CO‚ÇÇ (kg)",
          data: data,
          borderColor: "green",
          backgroundColor: "rgba(0, 128, 0, 0.15)",
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: "green",
          pointHoverBackgroundColor: "darkgreen",
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart',
        },
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            position: "top",
            labels: {
              color: "green",
              font: { weight: 'bold' }
            }
          },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0, 128, 0, 0.8)',
            titleFont: { weight: 'bold' },
            callbacks: {
              label: ctx => `${ctx.parsed.y} kg CO‚ÇÇ`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: 'green', font: { weight: 'bold' } },
            grid: { color: 'rgba(0,128,0,0.1)' }
          },
          x: {
            ticks: { color: 'green', font: { weight: 'bold' } },
            grid: { color: 'rgba(0,128,0,0.1)' }
          }
        }
      }
    });

    // Doughnut Chart: Recyclability with "No Data" handling
    const recyclable = {{ percent_recyclable | default('null') }};
    let recycleData, recycleLabels, recycleColors;

    if (recyclable === null || recyclable === 0) {
      // No data or zero recyclable - show 'No Data' slice in gray
      recycleData = [1];
      recycleLabels = ["No Data"];
      recycleColors = ["#6c757d"]; // Bootstrap gray
    } else {
      recycleData = [recyclable, 100 - recyclable];
      recycleLabels = ["Recyclable", "Non-Recyclable"];
      recycleColors = ["#198754", "#dc3545"];
    }

    new Chart(document.getElementById("recycleChart"), {
      type: "doughnut",
      data: {
        labels: recycleLabels,
        datasets: [{
          data: recycleData,
          backgroundColor: recycleColors,
          borderColor: "#fff",
          borderWidth: 2,
          hoverOffset: 30,
        }]
      },
      options: {
        responsive: true,
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1200,
          easing: 'easeOutBounce'
        },
        plugins: {
          legend: {
            display: true,
            position: "bottom",
            labels: {
              color: "#333",
              font: { weight: 'bold' },
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 15,
            },
            onHover: (e, legendItem, legend) => {
              e.native.target.style.cursor = 'pointer';
            }
          },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.parsed}%`;
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          intersect: true,
        }
      }
    });
  </script>
</body>

</html>
